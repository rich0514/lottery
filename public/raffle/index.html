<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç°¡æ˜“æŠ½çç¨‹å¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- å¼•å…¥ SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #F8F1E9; padding: 20px; }
    .container { max-width: 600px; margin: auto; text-align: center; }
    input, select, button { margin: 8px 0; padding: 10px; width: 100%; max-width: 300px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #CCC; padding: 8px; vertical-align: top; }
    th { background: #EEE; }
    /* è®“ cell å…§å®¹è¶…é•·æ™‚è‡ªå‹•æ›è¡Œ */
    td {
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æŠ½çç¨‹å¼</h1>
    <p>ä¸Šå‚³åå–®æª”æ¡ˆï¼ˆExcel æˆ– CSVï¼‰ï¼š</p>
    <input type="file" id="fileInput" accept=".xlsx,.csv" />
    <p>æŠ½å‡ºåé¡ï¼š</p>
    <select id="numWinners">
      <option value="1">1 äºº</option>
      <option value="2">2 äºº</option>
      <option value="3" selected>3 äºº</option>
      <option value="5">5 äºº</option>
      <option value="10">10 äºº</option>
    </select>
    <button id="drawBtn" disabled>ğŸ‰ é–‹å§‹æŠ½ç</button>
    <table id="resultTable" style="display:none;">
      <thead id="tblHead"></thead>
      <tbody id="tblBody"></tbody>
    </table>
  </div>

  <script>
    let records = [], numericCols = {};

    document.getElementById('fileInput').addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      records = XLSX.utils.sheet_to_json(ws);
      if (records.length) {
        analyzeColumns(records);
        document.getElementById('drawBtn').disabled = false;
        alert(`å·²è¼‰å…¥ ${records.length} ç­†è³‡æ–™`);
      }
    });

    document.getElementById('drawBtn').addEventListener('click', () => {
      const n = +document.getElementById('numWinners').value;
      const winners = [];
      const copy = [...records];
      for (let i = 0; i < Math.min(n, copy.length); i++) {
        const idx = Math.floor(Math.random() * copy.length);
        winners.push(copy.splice(idx, 1)[0]);
      }
      renderTable(winners);
    });

    function analyzeColumns(data) {
      // åªåˆ¤æ–·å“ªäº›æ¬„ä½æ˜¯ç´”æ•¸å€¼ï¼Œç”¨æ–¼èª¿æ•´å¯¬åº¦
      const cols = Object.keys(data[0]);
      cols.forEach(col => {
        numericCols[col] = data.every(r => !isNaN(parseFloat(r[col])));
      });
    }

    function renderTable(data) {
      const head = document.getElementById('tblHead'),
            body = document.getElementById('tblBody');
      head.innerHTML = ''; body.innerHTML = '';
      if (!data.length) return;
      const cols = Object.keys(data[0]);

      // è¡¨é ­
      const trh = document.createElement('tr');
      cols.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        trh.appendChild(th);
      });
      head.appendChild(trh);

      // è¨ˆç®—æ•¸å€¼æ¬„ä½çš„æœ€å°/æœ€å¤§å€¼ï¼ˆç”¨æ–¼å¯¬åº¦ï¼‰
      const stats = {};
      cols.forEach(c => {
        if (numericCols[c]) {
          const nums = data.map(r => parseFloat(r[c]));
          stats[c] = { min: Math.min(...nums), max: Math.max(...nums) };
        }
      });

      // è³‡æ–™åˆ—
      data.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(c => {
          let v = row[c];
          const td = document.createElement('td');

          // è¶…é 30 å­—ï¼Œè‡ªå‹•æ¯ 30 å­—æ’å…¥æ›è¡Œ
          if (typeof v === 'string' && v.length > 30) {
            v = v.match(/.{1,30}/g).join('\n');
          }

          td.textContent = v;

          // å¦‚æœæ˜¯æ•¸å€¼æ¬„ä½ï¼Œæ ¹æ“šå¤§å°èª¿æ•´å¯¬åº¦
          if (numericCols[c]) {
            const num = parseFloat(row[c]);
            const { min, max } = stats[c];
            const w = (min === max) ? 100 : 50 + ((num - min) / (max - min)) * 150;
            td.style.width = w + 'px';
          }

          tr.appendChild(td);
        });
        body.appendChild(tr);
      });

      document.getElementById('resultTable').style.display = 'table';
    }
  </script>
</body>
</html>
